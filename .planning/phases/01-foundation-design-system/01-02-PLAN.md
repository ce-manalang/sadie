---
phase: 01-foundation-design-system
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useAuth.js
  - src/hooks/useLibraryBooks.js
  - src/hooks/useBookDetail.js
  - src/components/ErrorFallback.jsx
autonomous: true
requirements:
  - FOUND-02
  - FOUND-03

must_haves:
  truths:
    - "useLibraryBooks hook returns { books, loading, error, removeBook, refetch } as an object"
    - "useBookDetail hook returns { book, loading, error, addToLibrary, adding } as an object"
    - "useAuth hook returns { token, login, logout, isAuthenticated } as an object"
    - "ErrorFallback component renders reassuring message and retry button"
    - "All hooks use samClient instead of raw axios with hardcoded URLs"
  artifacts:
    - path: "src/hooks/useLibraryBooks.js"
      provides: "Library books data fetching and remove mutation"
      exports: ["useLibraryBooks"]
    - path: "src/hooks/useBookDetail.js"
      provides: "Single book detail fetching and add-to-library mutation"
      exports: ["useBookDetail"]
    - path: "src/hooks/useAuth.js"
      provides: "Authentication state management (login, logout, token)"
      exports: ["useAuth"]
    - path: "src/components/ErrorFallback.jsx"
      provides: "Calm error fallback UI with retry button"
      exports: ["ErrorFallback"]
  key_links:
    - from: "src/hooks/useLibraryBooks.js"
      to: "src/api/samClient.js"
      via: "import sam from samClient; uses sam.get/sam.delete instead of raw axios"
      pattern: "import.*samClient"
    - from: "src/hooks/useBookDetail.js"
      to: "src/api/samClient.js"
      via: "import sam from samClient; uses sam.get/sam.post"
      pattern: "import.*samClient"
    - from: "src/hooks/useAuth.js"
      to: "src/api/samClient.js"
      via: "import sam from samClient; uses sam.post for login"
      pattern: "import.*samClient"
---

<objective>
Create custom hooks for API logic extraction and the error fallback component.

Purpose: Page components currently mix data fetching, state management, and rendering. Custom hooks separate concerns so components focus on presentation. The ErrorFallback provides a calm recovery UI per user decision ("Something went wrong. Your books are safe." with a retry button). These are created independently of the visual restyling so they can be wired in during Plan 03.

Output: Three custom hooks (useAuth, useLibraryBooks, useBookDetail) and ErrorFallback component.
</objective>

<execution_context>
@/Users/august/.claude/get-shit-done/workflows/execute-plan.md
@/Users/august/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-design-system/01-CONTEXT.md
@.planning/phases/01-foundation-design-system/01-RESEARCH.md
@src/api/samClient.js
@src/components/Dashboard.jsx
@src/components/BookDetail.jsx
@src/components/Login.jsx
@src/App.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create custom hooks for API logic</name>
  <files>src/hooks/useLibraryBooks.js, src/hooks/useBookDetail.js, src/hooks/useAuth.js, src/api/samClient.js</files>
  <action>
    Create `src/hooks/` directory.

    First, update `src/api/samClient.js` to add an auth header interceptor so hooks don't need to manually attach tokens:
    ```js
    import axios from 'axios';

    const sam = axios.create({
      baseURL: import.meta.env.VITE_API_URL || 'http://localhost:3000',
    });

    // Automatically attach auth token to requests
    sam.interceptors.request.use((config) => {
      const token = localStorage.getItem('token');
      if (token) {
        config.headers.Authorization = token;
      }
      return config;
    });

    export default sam;
    ```
    Remove the unused `getPublicBooks` export -- hooks replace it.

    **useLibraryBooks.js** -- Extract from Dashboard.jsx:
    - `useState` for books (array), loading (boolean), error (string|null)
    - `useCallback` wrapping fetchBooks that calls `sam.get('/library_books')`
    - `useEffect` calling fetchBooks on mount
    - `removeBook(bookId)` async function that calls `sam.delete(`/library_books/${bookId}`)`, optimistically removes from state, returns `{ success: true }` or `{ success: false, error: string }`
    - Returns `{ books, loading, error, removeBook, refetch: fetchBooks }`
    - All API calls go through samClient (NOT raw axios with hardcoded URLs)

    **useBookDetail.js** -- Extract from BookDetail.jsx:
    - Takes `bookId` parameter
    - `useState` for book (object|null), loading (boolean), error (string|null), adding (boolean)
    - `useEffect` fetching `sam.get(`/books/${bookId}`)` when bookId changes
    - `addToLibrary()` async function that posts to `sam.post('/library_books', { library_book: { dato_book_id: bookId, status: 'to-read' } })`, then refetches book data. Returns `{ success: true }` or `{ success: false, error: string }`
    - Returns `{ book, loading, error, addToLibrary, adding }`
    - Note: the auth token interceptor on samClient handles auth automatically

    **useAuth.js** -- Extract from App.jsx and Login.jsx:
    - `useState` for token, initialized from `localStorage.getItem('token')`
    - `login(email, password)` async function that posts to `sam.post('/users/sign_in', { user: { email, password } }, { headers: { Accept: 'application/json' } })`. Extracts token from `response.headers.authorization`, stores in localStorage, updates state. Returns `{ success: true }` or `{ success: false, error: string }`
    - `logout()` function that removes token from localStorage and sets state to null
    - `isAuthenticated` computed as `!!token`
    - Returns `{ token, login, logout, isAuthenticated }`

    IMPORTANT: These hooks are CREATED but NOT wired into components yet. Plan 03 handles the wiring. This allows Plan 01 and 02 to run in parallel without file conflicts.
  </action>
  <verify>
    Confirm all three hook files exist:
    ```
    ls src/hooks/useLibraryBooks.js src/hooks/useBookDetail.js src/hooks/useAuth.js
    ```
    Grep each file for "return {" to confirm they return objects (not arrays).
    Grep each file for "samClient" to confirm they use the centralized API client.
    Run `npm run build` to confirm no syntax errors.
  </verify>
  <done>Three custom hooks created in src/hooks/. Each returns an explicit object. All use samClient with auth interceptor instead of raw axios with hardcoded URLs. Hooks are not yet wired into page components (Plan 03 handles that).</done>
</task>

<task type="auto">
  <name>Task 2: Create ErrorFallback component</name>
  <files>src/components/ErrorFallback.jsx</files>
  <action>
    Create `src/components/ErrorFallback.jsx` with the calm error fallback UI.

    Per user decisions:
    - Tone: Warm and reassuring -- "Something went wrong. Your books are safe."
    - Visual: Simple line illustration or icon (use an inline SVG of an open book icon -- keeps it thematic without adding dependencies)
    - Scope: Full page -- fills the viewport with centered error content
    - Recovery: Manual retry button ("Try again") using resetErrorBoundary prop

    The component receives `{ error, resetErrorBoundary }` props from react-error-boundary.

    Layout:
    - `min-h-screen` with `bg-background` (from design tokens)
    - Centered content with max-w-md
    - SVG book icon (24x24 viewBox scaled to w-20 h-20, using gray-400 stroke, strokeWidth 1.5)
    - Heading: "Something went wrong" in font-display (Syne Mono) text-2xl
    - Body: "Your books are safe. We hit a snag loading this page." in text-gray-600 with leading-relaxed
    - Button: "Try again" with bg-teal-500 hover:bg-teal-600 text-white px-6 py-3 rounded-card (using design tokens)
    - Transition on button: `transition-colors duration-200`

    Use a simple open book SVG path for the icon (the one from RESEARCH.md):
    ```
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
    ```

    Export as named export: `export function ErrorFallback(...)`.

    NOTE: This component is CREATED but NOT wired into App.jsx yet. Plan 03 wraps routes with ErrorBoundary using this fallback. This avoids file conflicts since Plan 03 also modifies App.jsx.
  </action>
  <verify>
    Confirm file exists: `ls src/components/ErrorFallback.jsx`
    Grep for "resetErrorBoundary" to confirm it accepts the react-error-boundary prop.
    Grep for "Your books are safe" to confirm the reassuring message.
    Grep for "Try again" to confirm the retry button text.
    Run `npm run build` to confirm no syntax errors.
  </verify>
  <done>ErrorFallback component created with warm, reassuring messaging ("Something went wrong. Your books are safe."), open book SVG icon, and "Try again" retry button. Uses design token classes (bg-background, bg-teal-500, rounded-card, font-display). Not yet wired into App -- Plan 03 handles ErrorBoundary integration.</done>
</task>

</tasks>

<verification>
1. `ls src/hooks/` shows useAuth.js, useLibraryBooks.js, useBookDetail.js
2. `ls src/components/ErrorFallback.jsx` exists
3. All hooks return objects (grep for "return {")
4. All hooks import from samClient (grep for "samClient")
5. ErrorFallback has "Your books are safe" and "Try again"
6. `npm run build` succeeds
</verification>

<success_criteria>
- Three custom hooks extract all API logic from page components
- Hooks use samClient with auth interceptor (no hardcoded URLs)
- Hooks return explicit objects (not arrays)
- ErrorFallback displays calm, reassuring error UI with retry
- All files pass build without errors
- No existing components modified (wiring happens in Plan 03)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-design-system/01-02-SUMMARY.md`
</output>
